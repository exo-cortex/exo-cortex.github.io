<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>rust_tricks_generic_output_functions - exo-cortex: weblog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I&rsquo;m re-writing my network-delay-differential-equations-solver from my master thesis &mdash; this time in Rust (of course!). The idea is to learn more about the language. That&rsquo;s why I try to tackle problems by using clever new approaches that Rust enables me to do. Along the way I there&rsquo;ve been a few tricks that I learned or that nice people taught me which made it or will make it into the program. This one came from a friend who&rsquo;s much more experienced in such things:"><meta property="og:image" content><meta property="og:title" content="rust_tricks_generic_output_functions"><meta property="og:description" content="I&rsquo;m re-writing my network-delay-differential-equations-solver from my master thesis &mdash; this time in Rust (of course!). The idea is to learn more about the language. That&rsquo;s why I try to tackle problems by using clever new approaches that Rust enables me to do. Along the way I there&rsquo;ve been a few tricks that I learned or that nice people taught me which made it or will make it into the program. This one came from a friend who&rsquo;s much more experienced in such things:"><meta property="og:type" content="article"><meta property="og:url" content="https://exo-cortex.github.io/blog/rust_tricks_generic_output_functions/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-10-30T22:02:05+01:00"><meta property="article:modified_time" content="2023-10-30T22:02:05+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="rust_tricks_generic_output_functions"><meta name=twitter:description content="I&rsquo;m re-writing my network-delay-differential-equations-solver from my master thesis &mdash; this time in Rust (of course!). The idea is to learn more about the language. That&rsquo;s why I try to tackle problems by using clever new approaches that Rust enables me to do. Along the way I there&rsquo;ve been a few tricks that I learned or that nice people taught me which made it or will make it into the program. This one came from a friend who&rsquo;s much more experienced in such things:"><script src=https://exo-cortex.github.io/js/feather.min.js></script>
<link href=https://exo-cortex.github.io/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://exo-cortex.github.io/css/main.f354d104e4f25e1f0121dcd3bf611971d9a9e4c055e4c38c69de20042123a240.css></head><body><div class=content><header><div class=main><a href=https://exo-cortex.github.io/>exo-cortex: weblog</a></div><nav><a href=/>home</a>
<a href=/blog>blog</a>
<a href=/how-to>how-to</a>
<a href=/projects>projects</a>
<a href=/tags>tags</a>
<a href=/blogroll/blogroll>blogroll</a>
<a href=/about/about/>about</a></nav></header><main><article><div class=title><h1 class=title>rust_tricks_generic_output_functions</h1><div class=meta>posted: Oct 30, 2023</div></div><section class=body><p>I&rsquo;m re-writing my <a href=https://github.com/exo-cortex/dynamical_system_in_rust>network-delay-differential-equations-solver</a> from my master thesis &mdash; this time in Rust (of course!). The idea is to learn more about the language. That&rsquo;s why I try to tackle problems by using clever new approaches that Rust enables me to do.
Along the way I there&rsquo;ve been a few tricks that I learned or that nice people taught me which made it or will make it into the program. This one came from a friend who&rsquo;s much more experienced in such things:</p><h1 id=neat-trick-1>Neat trick #1</h1><p>So &mdash; I have a struct that is holding some data. As the structs data changes over time I want to keep either (<strong>a</strong>) <em><strong>all</strong></em>, (<strong>b</strong>) <em><strong>some</strong></em> of its data, (<strong>c</strong>) new data <em><strong>derived</strong></em> from the struct&rsquo;s data or (<strong>d</strong>) a <em><strong>combination</strong></em> of (<strong>a-c</strong>). So I have my struct <code>Data</code> and I need a way to have multiple <code>get_data()</code>-functions that return it in various ways (<strong>a</strong> - <strong>c</strong>):</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#408080;font-style:italic>// all the structs fields and output types are `f32` which is a random choice.
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>Data</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>x: <span style=color:#b00040>f32</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>y: <span style=color:#b00040>f32</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>z: <span style=color:#b00040>f32</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data_a</span>(d: <span style=color:green>&amp;</span><span style=color:#00f;font-weight:700>Data</span>)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span><span style=color:#666>3</span>]<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[d.x,<span style=color:#bbb> </span>d.y,<span style=color:#bbb> </span>d.z]<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// (a) all of `Data`
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data_b_z</span>(d: <span style=color:green>&amp;</span><span style=color:#00f;font-weight:700>Data</span>)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span><span style=color:#666>1</span>]<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[d.z]<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// (b) some of `Data` - in this case only `z` 
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data_c_1</span>(d: <span style=color:green>&amp;</span><span style=color:#00f;font-weight:700>Data</span>)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span><span style=color:#666>1</span>]<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[d.x.sqrt()]<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// (c) values derived through transforming `x`` 
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data_d_1</span>(d: <span style=color:green>&amp;</span><span style=color:#00f;font-weight:700>Data</span>)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span><span style=color:#666>4</span>]<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[d.x,<span style=color:#bbb> </span>d.x<span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span>d.y,<span style=color:#bbb> </span>d.y<span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span>d.z,<span style=color:#bbb> </span>d.z.sqrt()]<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// (d) some combination of the above
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>If needed I can define a large number of these <code>get_data_*()</code>-functions - I just need to pic a name and then I can call them from somewhere else.</p><p>But now I need to have multiple such <code>Data</code>-types that each have their own little zoo of <code>get_data_*()</code>-functions. Each is defined as a separate module:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>mod</span> <span style=color:#00f;font-weight:700>CoolData</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>Data</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>/* data */</span><span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data_1</span>(d: <span style=color:green>&amp;</span><span style=color:#00f;font-weight:700>Data</span>)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span>n_1]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data_N</span>(d: <span style=color:green>&amp;</span><span style=color:#00f;font-weight:700>Data</span>)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span>n_N]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>mod</span> <span style=color:#00f;font-weight:700>HappyData</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>Data</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>/* data */</span><span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data_1</span>(d: <span style=color:green>&amp;</span><span style=color:#00f;font-weight:700>Data</span>)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span>m_1]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data_M</span>(d: <span style=color:green>&amp;</span><span style=color:#00f;font-weight:700>Data</span>)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span>m_M]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// ... and so son
</span></span></span></code></pre></div><p>Somewhere else I want to write functions generically for all of my <code>Data</code>-types and use their <code>get_data_*()</code>-functions. The way to do it is to define a trait e.g. <code>DataHolder</code> that each <code>Data</code> has to implement in order to use these functions. Easy, that&rsquo;s how Rust&rsquo;s traits work.</p><p>But how can I use the <code>get_data_*()</code>-functions if each of these modules has a different number of <code>get_data_*()</code> and each have a different return-type? If I have all the <code>get_data_*()</code>&rsquo;s in the trait <code>DataHolder</code> across all modules we have to have the same number of these functions and each of them has to have the same return type. That&rsquo;s very impractical.</p><p>The solution is to define a different helper-type <code>As*</code> that only holds a reference to <code>Data</code> for each <code>get_data_*()</code> and a (const-)generic trait <code>get_data&lt;const N: usize></code> that each helper-type has to implement.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>Data</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span>x: <span style=color:#b00040>f32</span> }<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>trait</span><span style=color:#bbb> </span>GiveSomeData<span style=color:#666>&lt;</span><span style=color:green;font-weight:700>const</span><span style=color:#bbb> </span>N: <span style=color:#b00040>usize</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data</span>(<span style=color:#666>&amp;</span>self)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span>N];<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>AsA</span><span style=color:#666>&lt;</span><span style=color:#7d9029>&#39;a</span><span style=color:#666>&gt;</span>(<span style=color:#666>&amp;</span><span style=color:#7d9029>&#39;a</span><span style=color:#bbb> </span>Data);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>impl</span><span style=color:#666>&lt;</span><span style=color:#7d9029>&#39;a</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>GiveSomeData<span style=color:#666>&lt;</span><span style=color:#666>1</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>for</span><span style=color:#bbb> </span>AsA<span style=color:#666>&lt;</span><span style=color:#7d9029>&#39;a</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data</span>(<span style=color:#666>&amp;</span>self)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span><span style=color:#666>1</span>]<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>[self.<span style=color:#666>0.</span>x]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>AsB</span><span style=color:#666>&lt;</span><span style=color:#7d9029>&#39;a</span><span style=color:#666>&gt;</span>(<span style=color:#666>&amp;</span><span style=color:#7d9029>&#39;a</span><span style=color:#bbb> </span>Data);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>impl</span><span style=color:#666>&lt;</span><span style=color:#7d9029>&#39;a</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>GiveSomeData<span style=color:#666>&lt;</span><span style=color:#666>4</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>for</span><span style=color:#bbb> </span>AsB<span style=color:#666>&lt;</span><span style=color:#7d9029>&#39;a</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data</span>(<span style=color:#666>&amp;</span>self)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span><span style=color:#666>4</span>]<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>[self.<span style=color:#666>0.</span>x,<span style=color:#bbb> </span>self.<span style=color:#666>0.</span>x.sqrt(),<span style=color:#bbb> </span>self.<span style=color:#666>0.</span>x.exp(),<span style=color:#bbb> </span>self.<span style=color:#666>0.</span>x.sin()]<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// for example
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// use these 
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>use_data</span><span style=color:#666>&lt;</span><span style=color:green;font-weight:700>const</span><span style=color:#bbb> </span>N: <span style=color:#b00040>usize</span>,<span style=color:#bbb> </span>T: <span style=color:#00f;font-weight:700>GiveSomeData</span><span style=color:#666>&lt;</span>T<span style=color:#666>&gt;&gt;</span>(d: <span style=color:green>&amp;</span><span style=color:#00f;font-weight:700>T</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>println(<span style=color:#ba2121>&#34;{:?}&#34;</span>,<span style=color:#bbb> </span>t.get_data());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>voilà: Now each module can have their own set of various output formats and transformations that still adhere to a common interface.</p><p>My version will likely also have a second method required by <code>GiveSomeData&lt;N></code> that returns a <code>&'static [&'static]</code> in which each <code>get_data_*()</code>&rsquo;s output array&rsquo;s elements are described e.g. for <code>AsB</code> from above:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>impl</span><span style=color:#666>&lt;</span><span style=color:#7d9029>&#39;a</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>GiveSomeData<span style=color:#666>&lt;</span><span style=color:#666>4</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>for</span><span style=color:#bbb> </span>AsB<span style=color:#666>&lt;</span><span style=color:#7d9029>&#39;a</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data</span>(<span style=color:#666>&amp;</span>self)<span style=color:#bbb> </span>-&gt; [<span style=color:#b00040>f32</span>;<span style=color:#bbb> </span><span style=color:#666>4</span>]<span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>/* see above */</span><span style=color:#bbb> </span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>get_data_descriptions</span>()<span style=color:#bbb> </span>-&gt; <span style=color:green>&amp;</span><span style=color:green>&#39;static</span> [<span style=color:#666>&amp;</span><span style=color:green>&#39;static</span><span style=color:#bbb> </span><span style=color:#b00040>str</span>]<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>[<span style=color:#ba2121>&#34;x&#34;</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;sqrt_of_x&#34;</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;exp_of_x&#34;</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;sine_of_x&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>When writing each element of the the output array into a separate fil these files will be named according to <code>get_data_descriptions()</code>&rsquo;s output elements.</p><p>Now in my usecase these <code>get_data_*()</code>&rsquo;s will be called <em>all the time</em>, so they have to be fast and ideally should be optimized at compile time. So I need to tell the compiler to have each of them ready. I likely need a <code>match</code> that automatically adds arms for each existing <code>get_data_*()</code>. Likely I need a macro. But that is a tale for another time&mldr;</p></section><div class=post-tags></div></article></main><footer><hr><a class=soc href=https://github.com/exo-cortex title=GitHub><i data-feather=github></i></a>|2023 <a href=https://github.com/exo-cortex/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script>feather.replace()</script></div></body></html>